AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: SQL Query Generator with Natural Language - Production AI System

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Environment name
  
  SystemDBPassword:
    Type: String
    NoEcho: true
    Description: Password for the system RDS database
    MinLength: 8
  
  SampleDBPassword:
    Type: String
    NoEcho: true
    Description: Password for the sample ecommerce RDS database
    MinLength: 8
  
  AnthropicAPIKey:
    Type: String
    NoEcho: true
    Description: Anthropic API key for Claude
  
  ActivePhase:
    Type: String
    Default: POC
    AllowedValues:
      - POC
      - BREAKING_DEMO
      - PRODUCTION
    Description: |
      Active phase for the system:
      POC = Basic functionality, no caching, minimal validation
      BREAKING_DEMO = Shows security issues and failures (warnings only)
      PRODUCTION = Full features with caching, security blocking, monitoring

Globals:
  Function:
    Runtime: python3.11
    Timeout: 30
    MemorySize: 512
    Environment:
      Variables:
        ENVIRONMENT: !Ref Environment
        ACTIVE_PHASE: !Ref ActivePhase
        SYSTEM_DB_HOST: !GetAtt SystemDatabase.Endpoint.Address
        SYSTEM_DB_NAME: sql_query_generator
        SYSTEM_DB_USER: admin_user
        SYSTEM_DB_PASSWORD: !Ref SystemDBPassword
        CACHE_TABLE_NAME: !Ref QueryCacheTable
        ANTHROPIC_API_KEY: !Ref AnthropicAPIKey

Resources:
  # ===========================
  # VPC Configuration
  # ===========================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-vpc

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-public-subnet-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-public-subnet-2

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-private-subnet-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-private-subnet-2

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # ===========================
  # RDS - System Database
  # ===========================
  SystemDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for system database
      SubnetIds:
        - !Ref PublicSubnet1  # Changed to public
        - !Ref PublicSubnet2  # Changed to public
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-system-db-subnet-group

  SystemDBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for system RDS database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 0.0.0.0/0  # Allow from anywhere (for development)
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-system-db-sg

  SystemDatabase:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub ${AWS::StackName}-system-db
      DBName: sql_query_generator
      Engine: postgres
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      StorageType: gp2
      MasterUsername: admin_user
      MasterUserPassword: !Ref SystemDBPassword
      DBSubnetGroupName: !Ref SystemDBSubnetGroup
      VPCSecurityGroups:
        - !Ref SystemDBSecurityGroup
      BackupRetentionPeriod: 7
      PubliclyAccessible: true  # Changed to true
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-system-database

  # ===========================
  # RDS - Sample E-commerce Database
  # ===========================
  SampleDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for sample database
      SubnetIds:
        - !Ref PublicSubnet1  # Changed to public
        - !Ref PublicSubnet2  # Changed to public
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-sample-db-subnet-group

  SampleDBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for sample RDS database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 0.0.0.0/0  # Allow from anywhere (for development)
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-sample-db-sg

  SampleDatabase:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub ${AWS::StackName}-sample-db
      DBName: ecommerce
      Engine: postgres
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      StorageType: gp2
      MasterUsername: admin_user
      MasterUserPassword: !Ref SampleDBPassword
      DBSubnetGroupName: !Ref SampleDBSubnetGroup
      VPCSecurityGroups:
        - !Ref SampleDBSecurityGroup
      BackupRetentionPeriod: 7
      PubliclyAccessible: true  # Changed to true
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-sample-database

  # ===========================
  # DynamoDB - Query Cache
  # ===========================
  QueryCacheTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-query-cache
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: cache_key
          AttributeType: S
        - AttributeName: team_id
          AttributeType: S
      KeySchema:
        - AttributeName: cache_key
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: team-index
          KeySchema:
            - AttributeName: team_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-query-cache

  # ===========================
  # Lambda Security Group
  # ===========================
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-lambda-sg

  # ===========================
  # API Gateway
  # ===========================
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub ${AWS::StackName}-api
      StageName: !Ref Environment
      Cors:
        AllowOrigin: "'*'"
        AllowHeaders: "'Content-Type,X-Api-Key,Authorization'"
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      # Temporarily disable API key for easier testing
      # Auth:
      #   ApiKeyRequired: true
      #   UsagePlan:
      #     CreateUsagePlan: PER_API
      #     Quota:
      #       Limit: 1000
      #       Period: MONTH
      #     Throttle:
      #       RateLimit: 10
      #       BurstLimit: 20

  # ===========================
  # Lambda: API Key Authorizer
  # ===========================
  AuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AWS::StackName}-authorizer
      CodeUri: backend/src/authorizer/
      Handler: app.lambda_handler
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PublicSubnet1  # Changed to public
          - !Ref PublicSubnet2  # Changed to public
      Policies:
        - VPCAccessPolicy: {}

  # ===========================
  # Lambda: Query Generator
  # ===========================
  QueryGeneratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AWS::StackName}-query-generator
      CodeUri: backend/src/query_generator/
      Handler: app.lambda_handler
      Timeout: 60
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PublicSubnet1
          - !Ref PublicSubnet2
      Environment:
        Variables:
          SAMPLE_DB_HOST: !GetAtt SampleDatabase.Endpoint.Address
          SAMPLE_DB_NAME: ecommerce
          SAMPLE_DB_USER: admin_user
          SAMPLE_DB_PASSWORD: !Ref SampleDBPassword
      Events:
        GenerateQuery:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /query/generate
            Method: POST
            # Auth:
            #   ApiKeyRequired: true
      Policies:
        - VPCAccessPolicy: {}
        - DynamoDBCrudPolicy:
            TableName: !Ref QueryCacheTable
        - Statement:
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricData
              Resource: '*'

  # ===========================
  # Lambda: Query Refinement
  # ===========================
  QueryRefinementFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AWS::StackName}-query-refinement
      CodeUri: backend/src/query_generator/
      Handler: app.refinement_handler
      Timeout: 60
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PublicSubnet1
          - !Ref PublicSubnet2
      Environment:
        Variables:
          SAMPLE_DB_HOST: !GetAtt SampleDatabase.Endpoint.Address
          SAMPLE_DB_NAME: ecommerce
          SAMPLE_DB_USER: admin_user
          SAMPLE_DB_PASSWORD: !Ref SampleDBPassword
      Events:
        RefineQuery:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /query/refine
            Method: POST
            # Auth:
            #   ApiKeyRequired: true
      Policies:
        - VPCAccessPolicy: {}
        - DynamoDBCrudPolicy:
            TableName: !Ref QueryCacheTable

  # ===========================
  # Lambda: Feedback Handler
  # ===========================
  FeedbackFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AWS::StackName}-feedback
      CodeUri: backend/src/query_generator/
      Handler: app.feedback_handler
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PublicSubnet1
          - !Ref PublicSubnet2
      Events:
        SubmitFeedback:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /query/feedback
            Method: POST
            # Auth:
            #   ApiKeyRequired: true
      Policies:
        - VPCAccessPolicy: {}

  # ===========================
  # Lambda: Schema Uploader (OPTIONAL - Commented out for now)
  # ===========================
  # SchemaUploaderFunction:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     FunctionName: !Sub ${AWS::StackName}-schema-uploader
  #     CodeUri: backend/src/schema_uploader/
  #     Handler: app.lambda_handler
  #     Timeout: 120
  #     VpcConfig:
  #       SecurityGroupIds:
  #         - !Ref LambdaSecurityGroup
  #       SubnetIds:
  #         - !Ref PrivateSubnet1
  #         - !Ref PrivateSubnet2
  #     Events:
  #       UploadSchema:
  #         Type: Api
  #         Properties:
  #           RestApiId: !Ref ApiGateway
  #           Path: /schema/upload
  #           Method: POST
  #           Auth:
  #             ApiKeyRequired: true
  #     Policies:
  #       - VPCAccessPolicy: {}

  # ===========================
  # Lambda: Evaluation Aggregator
  # ===========================
  EvaluationAggregatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AWS::StackName}-evaluation-aggregator
      CodeUri: backend/src/evaluation/
      Handler: aggregator.lambda_handler
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PublicSubnet1
          - !Ref PublicSubnet2
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 0 * * ? *)
            Description: Run daily evaluation aggregation at midnight UTC
      Policies:
        - VPCAccessPolicy: {}
        - Statement:
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricData
              Resource: '*'

  # ===========================
  # Lambda: Model Testing (OPTIONAL - Commented out for now)
  # ===========================
  # ModelTestingFunction:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     FunctionName: !Sub ${AWS::StackName}-model-testing
  #     CodeUri: backend/src/evaluation/
  #     Handler: model_tests.lambda_handler
  #     Timeout: 300
  #     MemorySize: 1024
  #     VpcConfig:
  #       SecurityGroupIds:
  #         - !Ref LambdaSecurityGroup
  #       SubnetIds:
  #         - !Ref PrivateSubnet1
  #         - !Ref PrivateSubnet2
  #     Events:
  #       TestEndpoint:
  #         Type: Api
  #         Properties:
  #           RestApiId: !Ref ApiGateway
  #           Path: /evaluation/tests/run
  #           Method: POST
  #           Auth:
  #             ApiKeyRequired: true
  #     Policies:
  #       - VPCAccessPolicy: {}

  # ===========================
  # Lambda: Metrics API (OPTIONAL - Commented out for now)
  # ===========================
  # MetricsFunction:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     FunctionName: !Sub ${AWS::StackName}-metrics
  #     CodeUri: backend/src/evaluation/
  #     Handler: metrics.lambda_handler
  #     VpcConfig:
  #       SecurityGroupIds:
  #         - !Ref LambdaSecurityGroup
  #       SubnetIds:
  #         - !Ref PrivateSubnet1
  #         - !Ref PrivateSubnet2
  #     Events:
  #       GetMetrics:
  #         Type: Api
  #         Properties:
  #           RestApiId: !Ref ApiGateway
  #           Path: /evaluation/metrics
  #           Method: GET
  #           Auth:
  #             ApiKeyRequired: true
  #     Policies:
  #       - VPCAccessPolicy: {}

  # ===========================
  # CloudWatch Alarms
  # ===========================
  HighErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${AWS::StackName}-high-error-rate
      AlarmDescription: Alert when error rate exceeds 20%
      MetricName: ErrorRate
      Namespace: SQLQueryGenerator
      Statistic: Average
      Period: 900
      EvaluationPeriods: 1
      Threshold: 20
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  LowSuccessRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${AWS::StackName}-low-success-rate
      AlarmDescription: Alert when success rate drops below 80%
      MetricName: SuccessRate
      Namespace: SQLQueryGenerator
      Statistic: Average
      Period: 3600
      EvaluationPeriods: 1
      Threshold: 80
      ComparisonOperator: LessThanThreshold
      TreatMissingData: notBreaching

  LowUserSatisfactionAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${AWS::StackName}-low-user-satisfaction
      AlarmDescription: Alert when average user rating drops below 3.5
      MetricName: AvgUserRating
      Namespace: SQLQueryGenerator
      Statistic: Average
      Period: 86400
      EvaluationPeriods: 1
      Threshold: 3.5
      ComparisonOperator: LessThanThreshold
      TreatMissingData: notBreaching

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${Environment}
    Export:
      Name: !Sub ${AWS::StackName}-api-endpoint

  SystemDatabaseEndpoint:
    Description: System RDS database endpoint
    Value: !GetAtt SystemDatabase.Endpoint.Address
    Export:
      Name: !Sub ${AWS::StackName}-system-db-endpoint

  SampleDatabaseEndpoint:
    Description: Sample RDS database endpoint
    Value: !GetAtt SampleDatabase.Endpoint.Address
    Export:
      Name: !Sub ${AWS::StackName}-sample-db-endpoint

  QueryCacheTableName:
    Description: DynamoDB query cache table name
    Value: !Ref QueryCacheTable
    Export:
      Name: !Sub ${AWS::StackName}-cache-table

  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub ${AWS::StackName}-vpc-id
